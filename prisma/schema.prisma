// Prisma schema for SSDF + CIS assessment app

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ASSESSOR
  VIEWER
}

enum SsdfStatus {
  NOT_STARTED
  IN_PROGRESS
  IMPLEMENTED
  NOT_APPLICABLE
}

enum CisStatus {
  NOT_STARTED
  IN_PROGRESS
  IMPLEMENTED
  NOT_APPLICABLE
}

enum EvidenceType {
  DOCUMENTO
  TICKET
  URL
  PRINT
  PIPELINE
  OUTRO
}

enum MetricType {
  QUANT
  QUAL
}

enum MappingType {
  DIRECT
  PARTIAL
  SUPPORTS
}

enum ImplementationGroup {
  IG1
  IG2
  IG3
}

enum DgLevel {
  DG1
  DG2
  DG3
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  OTHER
}

enum AssessmentReleaseStatus {
  DRAFT
  IN_REVIEW
  APPROVED
}

enum EvidenceReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EditingMode {
  LOCKED_ADMIN_ONLY
  UNLOCKED_FOR_ASSESSORS
}

model User {
  id           String      @id @default(cuid()) @map("id")
  name         String      @map("name")
  email        String      @unique @map("email")
  passwordHash String      @map("password_hash")
  role         Role        @default(VIEWER) @map("role")
  mustChangePassword Boolean @default(true) @map("must_change_password")
  passwordChangedAt DateTime? @map("password_changed_at")
  deletedAt    DateTime?   @map("deleted_at")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  assessmentsCreated Assessment[] @relation("AssessmentCreatedBy")
  editingLocks Assessment[] @relation("AssessmentEditingLockedBy")
  assessmentReleasesCreated AssessmentRelease[] @relation("AssessmentReleaseCreatedBy")
  assessmentReleasesApproved AssessmentRelease[] @relation("AssessmentReleaseApprovedBy")
  ssdfResultsUpdated AssessmentSsdfTaskResult[] @relation("SsdfResultUpdatedBy")
  cisResultsUpdated AssessmentCisResult[] @relation("CisResultUpdatedBy")
  userOrganizations UserOrganization[]
  assessmentTaskHistories AssessmentTaskHistory[] @relation("AssessmentTaskHistoryChangedBy")
  evidenceHistories EvidenceHistory[] @relation("EvidenceHistoryChangedBy")
  auditLogs    AuditLog[]

  @@index([deletedAt])
  @@map("users")
}

model Organization {
  id        String       @id @default(cuid()) @map("id")
  name      String       @unique @map("name")
  deletedAt DateTime?    @map("deleted_at")
  enforceSso Boolean     @default(false) @map("enforce_sso")
  ssoProviderKey String? @map("sso_provider_key")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  assessments Assessment[]
  userOrganizations UserOrganization[]
  auditLogs AuditLog[]

  @@map("organizations")
}

model UserOrganization {
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  user           User     @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime @default(now()) @map("created_at")

  @@id([userId, organizationId])
  @@index([organizationId])
  @@map("user_organizations")
}

model Assessment {
  id              String    @id @default(cuid()) @map("id")
  organizationId  String    @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id])
  name            String    @default("Assessment") @map("name")
  unit            String    @map("unit")
  scope           String    @map("scope")
  assessmentOwner String    @map("assessment_owner")
  dgLevel         DgLevel   @default(DG1) @map("dg_level")
  startDate       DateTime  @map("start_date")
  reviewDate      DateTime? @map("review_date")
  notes           String?   @map("notes") @db.Text
  editingMode     EditingMode @default(UNLOCKED_FOR_ASSESSORS) @map("editing_mode")
  editingLockedByUserId String? @map("editing_locked_by_user_id")
  editingLockedByUser User? @relation("AssessmentEditingLockedBy", fields: [editingLockedByUserId], references: [id])
  editingLockedAt DateTime? @map("editing_locked_at")
  editingLockNote String?   @map("editing_lock_note") @db.Text
  deletedAt       DateTime? @map("deleted_at")
  createdById     String?   @map("created_by_id")
  createdBy       User?     @relation("AssessmentCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  ssdfResults     AssessmentSsdfTaskResult[]
  cisResults      AssessmentCisResult[]
  releases        AssessmentRelease[]

  @@index([organizationId])
  @@index([deletedAt])
  @@map("assessments")
}

model AssessmentRelease {
  id               String                  @id @default(cuid()) @map("id")
  assessmentId     String                  @map("assessment_id")
  assessment       Assessment              @relation(fields: [assessmentId], references: [id])
  status           AssessmentReleaseStatus @default(DRAFT) @map("status")
  notes            String?                 @map("notes") @db.Text
  createdAt        DateTime                @default(now()) @map("created_at")
  createdByUserId  String?                 @map("created_by_user_id")
  createdByUser    User?                   @relation("AssessmentReleaseCreatedBy", fields: [createdByUserId], references: [id])
  baseReleaseId    String?                 @map("base_release_id")
  baseRelease      AssessmentRelease?      @relation("AssessmentReleaseBase", fields: [baseReleaseId], references: [id])
  derivedReleases  AssessmentRelease[]     @relation("AssessmentReleaseBase")
  approvedAt       DateTime?               @map("approved_at")
  approvedByUserId String?                 @map("approved_by_user_id")
  approvedByUser   User?                   @relation("AssessmentReleaseApprovedBy", fields: [approvedByUserId], references: [id])
  snapshot         Json?                   @map("snapshot")

  @@index([assessmentId])
  @@index([status])
  @@index([baseReleaseId])
  @@map("assessment_releases")
}

model SsdfGroup {
  id          String        @id @map("id")
  name        String        @map("name")
  description String?       @map("description")
  practices   SsdfPractice[]

  @@map("ssdf_groups")
}

model SsdfPractice {
  id      String     @id @map("id")
  groupId String     @map("group_id")
  group   SsdfGroup  @relation(fields: [groupId], references: [id])
  name    String     @map("name")
  tasks   SsdfTask[]

  @@index([groupId])
  @@map("ssdf_practices")
}

model SsdfTask {
  id         String     @id @map("id")
  practiceId String     @map("practice_id")
  practice   SsdfPractice @relation(fields: [practiceId], references: [id])
  name       String     @map("name")
  examples   String?    @map("examples") @db.Text
  references String?    @map("references") @db.Text
  results    AssessmentSsdfTaskResult[]
  mappings   SsdfCisMapping[]

  @@index([practiceId])
  @@map("ssdf_tasks")
}

model AssessmentSsdfTaskResult {
  id            String     @id @default(cuid()) @map("id")
  assessmentId  String     @map("assessment_id")
  assessment    Assessment @relation(fields: [assessmentId], references: [id])
  ssdfTaskId    String     @map("ssdf_task_id")
  ssdfTask      SsdfTask   @relation(fields: [ssdfTaskId], references: [id])
  status        SsdfStatus @default(NOT_STARTED) @map("status")
  maturityLevel Int        @default(0) @map("maturity_level")
  targetLevel   Int        @default(2) @map("target_level")
  weight        Int        @default(3) @map("weight")
  metricValue   Float?     @map("metric_value")
  metricType    MetricType? @map("metric_type")
  evidenceText  String?    @map("evidence_text") @db.Text
  evidenceLinks String[]   @default([]) @map("evidence_links")
  owner         String?    @map("owner")
  team          String?    @map("team")
  dueDate       DateTime?  @map("due_date")
  lastReview    DateTime?  @map("last_review")
  comments      String?    @map("comments") @db.Text
  updatedById   String?    @map("updated_by_id")
  updatedBy     User?      @relation("SsdfResultUpdatedBy", fields: [updatedById], references: [id])
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  evidences     Evidence[]
  history       AssessmentTaskHistory[]

  @@unique([assessmentId, ssdfTaskId])
  @@index([assessmentId, status])
  @@index([ssdfTaskId])
  @@map("assessment_ssdf_task_results")
}

model Evidence {
  id          String     @id @default(cuid()) @map("id")
  ssdfResultId String    @map("ssdf_result_id")
  ssdfResult  AssessmentSsdfTaskResult @relation(fields: [ssdfResultId], references: [id])
  description String     @map("description")
  type        EvidenceType @map("type")
  reviewStatus EvidenceReviewStatus @default(PENDING) @map("review_status")
  link        String?    @map("link")
  owner       String?    @map("owner")
  date        DateTime?  @map("date")
  validUntil  DateTime?  @map("valid_until")
  notes       String?    @map("notes") @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  history     EvidenceHistory[]

  @@index([ssdfResultId])
  @@map("evidences")
}

model AssessmentTaskHistory {
  id                     String     @id @default(cuid()) @map("id")
  assessmentTaskResultId String     @map("assessment_task_result_id")
  assessmentTaskResult   AssessmentSsdfTaskResult @relation(fields: [assessmentTaskResultId], references: [id])
  changedAt              DateTime   @default(now()) @map("changed_at")
  changedByUserId        String?    @map("changed_by_user_id")
  changedByUser          User?      @relation("AssessmentTaskHistoryChangedBy", fields: [changedByUserId], references: [id])
  fieldName              String     @map("field_name")
  oldValue               String?    @map("old_value") @db.Text
  newValue               String?    @map("new_value") @db.Text
  reason                 String?    @map("reason") @db.Text
  requestId              String?    @map("request_id")
  ip                     String?    @map("ip")
  userAgent              String?    @map("user_agent") @db.Text
  metadata               Json?      @map("metadata")

  @@index([assessmentTaskResultId])
  @@index([changedAt])
  @@map("assessment_task_histories")
}

model EvidenceHistory {
  id              String     @id @default(cuid()) @map("id")
  evidenceId      String     @map("evidence_id")
  evidence        Evidence   @relation(fields: [evidenceId], references: [id])
  changedAt       DateTime   @default(now()) @map("changed_at")
  changedByUserId String?    @map("changed_by_user_id")
  changedByUser   User?      @relation("EvidenceHistoryChangedBy", fields: [changedByUserId], references: [id])
  fieldName       String     @map("field_name")
  oldValue        String?    @map("old_value") @db.Text
  newValue        String?    @map("new_value") @db.Text
  reason          String?    @map("reason") @db.Text
  metadata        Json?      @map("metadata")

  @@index([evidenceId])
  @@index([changedAt])
  @@map("evidence_histories")
}

model CisControl {
  id          String     @id @map("id")
  name        String     @map("name")
  description String?    @map("description") @db.Text
  safeguards  CisSafeguard[]
  mappings    SsdfCisMapping[]
  cisResults  AssessmentCisResult[]

  @@map("cis_controls")
}

model CisSafeguard {
  id          String     @id @map("id")
  controlId   String     @map("control_id")
  control     CisControl @relation(fields: [controlId], references: [id])
  name        String     @map("name")
  description String?    @map("description") @db.Text
  implementationGroup ImplementationGroup @map("implementation_group")
  mappings    SsdfCisMapping[]
  cisResults  AssessmentCisResult[]

  @@index([controlId])
  @@map("cis_safeguards")
}

model SsdfCisMapping {
  id             String     @id @default(cuid()) @map("id")
  ssdfTaskId     String     @map("ssdf_task_id")
  ssdfTask       SsdfTask   @relation(fields: [ssdfTaskId], references: [id])
  cisControlId   String?    @map("cis_control_id")
  cisControl     CisControl? @relation(fields: [cisControlId], references: [id])
  cisSafeguardId String?    @map("cis_safeguard_id")
  cisSafeguard   CisSafeguard? @relation(fields: [cisSafeguardId], references: [id])
  mappingType    MappingType @default(DIRECT) @map("mapping_type")
  weight         Float      @default(1) @map("weight")
  notes          String?    @map("notes") @db.Text
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  @@index([ssdfTaskId])
  @@index([cisControlId])
  @@index([cisSafeguardId])
  @@unique([ssdfTaskId, cisControlId, cisSafeguardId])
  @@map("ssdf_cis_mappings")
}

model AssessmentCisResult {
  id                   String     @id @default(cuid()) @map("id")
  assessmentId         String     @map("assessment_id")
  assessment           Assessment @relation(fields: [assessmentId], references: [id])
  cisControlId         String?    @map("cis_control_id")
  cisControl           CisControl? @relation(fields: [cisControlId], references: [id])
  cisSafeguardId       String?    @map("cis_safeguard_id")
  cisSafeguard         CisSafeguard? @relation(fields: [cisSafeguardId], references: [id])
  derivedStatus        CisStatus? @map("derived_status")
  derivedMaturityLevel Int?       @map("derived_maturity_level")
  derivedCoverageScore Float?     @map("derived_coverage_score")
  derivedFromSsdf      Boolean    @default(true) @map("derived_from_ssdf")
  derivedFromTaskIds   String[]   @default([]) @map("derived_from_task_ids")
  manualOverride       Boolean    @default(false) @map("manual_override")
  manualStatus         CisStatus? @map("manual_status")
  manualMaturityLevel  Int?       @map("manual_maturity_level")
  updatedById          String?    @map("updated_by_id")
  updatedBy            User?      @relation("CisResultUpdatedBy", fields: [updatedById], references: [id])
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  @@index([assessmentId])
  @@index([cisControlId])
  @@index([cisSafeguardId])
  @@unique([assessmentId, cisControlId, cisSafeguardId])
  @@map("assessment_cis_results")
}

model AuditLog {
  id            String      @id @default(uuid()) @map("id")
  timestamp     DateTime    @default(now()) @map("created_at")
  actorUserId   String?     @map("user_id")
  actorUser     User?       @relation(fields: [actorUserId], references: [id])
  actorEmail    String?     @map("actor_email")
  actorRole     Role?       @map("actor_role")
  organizationId String?    @map("organization_id")
  organization  Organization? @relation(fields: [organizationId], references: [id])
  action        AuditAction @default(OTHER) @map("action")
  entityType    String?     @map("entity")
  entityId      String?     @map("entity_id")
  fieldName     String?     @map("field_name")
  oldValue      String?     @map("old_value") @db.Text
  newValue      String?     @map("new_value") @db.Text
  metadata      Json?       @map("metadata")
  success       Boolean     @default(true) @map("success")
  errorMessage  String?     @map("error_message") @db.Text
  requestId     String?     @map("request_id")
  legacyBefore  Json?       @map("before")
  legacyAfter   Json?       @map("after")

  @@index([entityType, entityId])
  @@index([organizationId])
  @@map("audit_logs")
}

model AuthConfig {
  id                 String   @id @default(cuid()) @map("id")
  key                String   @unique @default("default") @map("key")
  ssoEnabled         Boolean  @default(false) @map("sso_enabled")
  issuerUrl          String?  @map("issuer_url")
  clientId           String?  @map("client_id")
  scopes             String   @default("openid profile email") @map("scopes")
  allowPasswordLogin Boolean  @default(true) @map("allow_password_login")
  domainAllowList    String[] @default([]) @map("domain_allow_list")
  enforceSso         Boolean  @default(false) @map("enforce_sso")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("auth_configs")
}
